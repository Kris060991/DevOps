## Часть 1. Инструмент ipcalc     
1. Сети и маски.  
   - установить ipcalc: sudo apt install ipcalc
   - сетевой адрес 192.167.38.54/13: Сетевой адрес (строка Network) — 192.160.0.0/13.     
    ![сетевой адрес 192.167.38.54/13](img/1-ipcalc-192.167.38.54.png)    
   - преобразование маски 255.255.255.0 в префиксную и двоичную: ipcalc 255.255.255.0  
    префикс-24, двоичная-11111111.11111111.11111111.00000000     
    ![преобразование маски 255.255.255.0](img/1-ipcalc-255.255.255.0.png)
   - /15 в обычную и двоичную: ipcalc /15     
    обычная - 255.254.0.0, двоичная - 11111111.11111110.00000000.00000000
    ![преобразование маски /15](img/1-ipcalc-15.png)
   - 11111111.11111111.11111111.11110000 в обычную и префиксную:   
    Утилита ipcalc не принимает на вход двоичную маску напрямую. По таблице смотрим обычная запись - 255.255.255.240, префикс - 28
    ![преобразование 11111111.11111111.11111111.11110000](img/1-ipcalc-11111111.11111111.11111111.11110000.png)   
   - минимальный и максимальный хост в сети 12.167.38.4 с масками: /8 , 11111111.11111111.00000000.00000000 , 255.255.254.0 и /4: 
    ![минимальные и максимальные хосты по заданным маскам](img/1-ipcalc-max-min.png)

2. локальный хост   
  - устанавливаем nmap: sudo apt install nmap
  - Флаг -sS означает TCP SYN сканирование — быстрый и эффективный метод.
  - 194.34.23.100 - нет
  - 127.0.0.2 - да
  - 127.1.0.1 - да
  - 128.0.0.1 - нет.   
  ![использование nmap](img/1-nmap.png)

3. Диапазоны и сегменты сети. 
  - какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных:
    - Для определения типа адресов (частные/публичные) воспользуемся утилитой ipcalc
    - ipcalc 10.0.0.45 - частный
    - ipcalc 134.43.0.2 - публичный
    - ipcalc 192.168.4.2 - частный.   
    ![типы адресов 10.0.0.45, 134.43.0.2, 192.168.4.2](img/1-3-type%20of%20addresses1.png)   
    - ipcalc 172.20.250.4 - частный
    - ipcalc 172.0.2.1 - публичный
    - ipcalc 192.172.0.1 - публичный.    
    ![типы адресов 172.20.250.4, 172.0.2.1, 192.172.0.1](img/1-3-type%20of%20addresses2.png)   
    - ipcalc 172.68.0.2 - публичный
    - ipcalc 172.16.255.255 - частный
    - ipcalc 10.10.10.10 - частный.    
    ![типы адресов 172.68.0.2, 172.16.255.255, 10.10.10.10](img/1-3-type%20of%20addresses3.png)   
    - ipcalc 192.169.168.1 - публичный.     
    ![типы адресов 192.169.168.1](img/1-3-type%20of%20addresses4.png)
  - какие из перечисленных IP-адресов шлюза возможны для сети 10.10.0.0/18:
    - Определяем параметры сети 10.10.0.0/18: ipcalc 10.10.0.0/18.   
    ![параметры сети 10.10.0.0/18](img/1-10.10.0.0-18.png)    
    Диапазон хостов: 10.10.0.1 - 10.10.63.254
    - 10.0.0.1 - не входит в сеть 10.10.0.0/18
    ![параметры сети 10.0.0.1](img/1-10.0.0.1.png)   
    - 10.10.0.2 - входит в диапазон 10.10.0.1 - 10.10.63.254.    
    ![параметры сети 10.10.0.2](img/1-10.10.0.2.png)  
    - 10.10.10.10 - входит в диапазон 10.10.0.1 - 10.10.63.254.   
    ![параметры сети](img/1-10.10.10.10.png)  
    - 10.10.100.1 - не входит в сеть 10.10.0.0/18 (превышает HostMax).   
    ![параметры сети](img/1-10.10.100.1.png)   
    - 10.10.1.255 - входит в диапазон 10.10.0.1 - 10.10.63.254.  
    ![параметры сети](img/1-10.10.1.255.png)   

## Часть 2. Статическая маршрутизация между двумя машинами
1. Просмотреть существующие сетевые интерфейсы с помощью ip a команды 
![сетевые интерфейсы ws1](img/2-1-ws1.png)    
![сетевые интерфейсы ws2](img/2-1-ws2.png)    
2. Опишите сетевой интерфейс, соответствующий внутренней сети на обеих машинах, и задайте следующие адреса и маски: ws1 — 192.168.100.10 , маска */16 *, ws2 — 172.24.116.8 , маска /12       
![адреса и маски ws1](img/2-2-ws1.png)      
![адреса и маски ws2](img/2-2-ws2.png)
3. Выполните netplan apply команду для перезапуска сетевой службы.    
![netplan apply для ws1](img/2-3-ws1.png)    
![netplan apply для ws2](img/2-3-ws2.png)      
4. Добавьте статический маршрут от одной машины к другой и обратно с помощью ip r add команда.  
- в настройках: сеть - Сетевой мост 
- ws1 - sudo ip r add 172.24.116.8/32 dev enp0s8
- ws2 - sudo ip r add 192.168.100.10/32 dev enp0s8 
/32 — это маска подсети, которая означает "только один конкретный IP-адрес"
- Проверка маршрутов после добавления - ip r
- Проверка соединения ws1: ping -c 4 172.24.116.8      
![Проверка соединения ws1](img/2-4-ws1.png)      
- Проверка соединения ws2: ping -c 4 192.168.100.10     
![Проверка соединения ws2](img/2-4-ws2.png)     
5. Добавьте статический маршрут с одной машины на другую, используя файл /etc/netplan/00-installer-config.yaml     
- Перезапусти машины: sudo reboot
- sudo nano /etc/netplan/00-installer-config.yaml
![статический маршрут ws1](img/2-5-1-ws1.png)     
![статический маршрут ws2](img/2-5-1-ws2.png)    
- sudo netplan apply
- Проверка соединения ping
![Проверка соединения ws1](img/2-5-2-ws1.png)     
![Проверка соединения ws2](img/2-5-2-ws2.png)    

## Part 3. Утилита iperf3
1. Скорость соединения. Переведи и запиши в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps.   
- 8 Mbps в MB/s = 8 Мегабит/с = 1 МБайт/с 
- 100 MB/s в Kbps = 100 МБайт/с * 8 = 800 Мегабит/с * 1000 = 800000 Килобит/с
- 1 Gbps в Mbps = 1 Гигабит/с × 1000 = 1000 Мегабит/с
2. Утилита iperf3. Измерь скорость соединения между ws1 и ws2.   
- установить iperf3: sudo apt install iperf3
- На машине ws2 (172.24.116.8) запустите iperf3 в режиме сервера: iperf3 -s    
![iperf3 в режиме сервера ws2](img/3-2-1-ws2.png)   
- На машине ws1 (192.168.100.10) запустите iperf3 в режиме клиента: iperf3 -c 172.24.116.8   
![iperf3 в режиме клиента ws1](img/3-2-1-ws1.png)    
- Тест в обратном направлении:  На ws1 запустите сервер: iperf3 -s    
![iperf3 в режиме сервера ws1](img/3-2-2-ws1.png)  
- На ws2 запустите клиент: iperf3 -c 192.168.100.10     
![iperf3 в режиме клиента ws2](img/3-2-2-ws2.png)   

## Part 4. Сетевой экран 
1. Утилита iptables   
![Запрет → Разрешение](img/4-1-ws1.png)    
![Разрешение → Запрет](img/4-1-ws2.png)    
Запусти файлы на обеих машинах командами chmod +x /etc/firewall.sh и /etc/firewall.sh.
![Запуск на ws1](img/4-1-ws1-start.png)    
![Запуск на ws2](img/4-1-ws2-start.png)    
- WS1: Стратегия "Запрет → Разрешение": Правило ACCEPT переопределяет DROP (последнее правило имеет приоритет). Машина будет: ПИНГОВАТЬСЯ (так как разрешающее правило идет последним)
- WS2: Стратегия "Разрешение → Запрет": Правило DROP переопределяет ACCEPT (последнее правило имеет приоритет). Машина будет: НЕ ПИНГОВАТЬСЯ (так как запрещающее правило идет последним)
2. Утилита nmap
- устанавливаем nmap: sudo apt install nmap
- ws1: ping -c 4 172.24.116.8  
![ping ws1 с ws2](img/4-2-ws1.png)   
- ws2: ping -c 4 192.168.100.10   
- ws2 не пингуется: sudo nmap 192.168.100.10    
![ping ws2 с ws1 и nmap](img/4-2-ws2.png)     

## Part 5. Статическая маршрутизация сети
1. - Настройка адресов машин   
![Настройка r1](img/5-r1.png)    
![Настройка r2](img/5-r2.png)    
![Настройка ws11](img/5-ws11.png)   
![Настройка ws21](img/5-ws21.png)    
![Настройка ws22](img/5-ws22.png)    
- Перезапусти сервис сети. Если ошибок нет, командой ip -4 a проверь, что адрес машины задан верно.  
![проверка r1](img/5-r1-ip-a.png)   
![проверка r2](img/5-r2-ip-a.png)   
![проверка ws11](img/5-ws11-ip-a.png)    
![проверка ws21](img/5-ws21-ip-a.png)   
![проверка ws22](img/5-ws22-ip-a.png)    
- Настройка маршрутизации: 
  - на r1: sudo ip r add 10.20.0.0/26 dev enp0s8   
  - на r2: sudo ip r add 10.10.0.0/18 dev enp0s8
- пропингуй ws22 с ws21      
![ping ws22 c ws21](img/5-ping-ws22-ws21.png)     
- пропингуй r1 с ws11         
![ping r1 c ws11](img/5-ping-r1-ws11.png)    
2. Включение переадресации IP-адресов    
- Для включения переадресации IP выполни команду на роутерах: sysctl -w net.ipv4.ip_forward=1     
При таком подходе переадресация не будет работать после перезагрузки системы.    
![Включение переадресации IP на r1](img/5-2-1-r1.png)     
![Включение переадресации IP на r2](img/5-2-1-r2.png)     
- Открой файл /etc/sysctl.conf и добавь в него следующую строку: net.ipv4.ip_forward = 1      
При использовании этого подхода, IP-переадресация включена на постоянной основе.     
![редактирование /etc/sysctl.conf на r1](img/5-2-2-r1.png)     
![редактирование /etc/sysctl.conf на r2](img/5-2-2-r2.png)     
3. Установка маршрута по умолчанию.      
- Настрой маршрут по умолчанию (шлюз) для рабочих станций. Для этого добавь default перед IP-роутера в файле конфигураций.     
![netplan ws11](img/5-3-netplan-ws11.png)     
![netplan ws21](img/5-3-netplan-ws21.png)     
![netplan ws22](img/5-3-netplan-ws22.png)      
sudo netplan apply     
- Вызови ip r и покажи, что добавился маршрут в таблицу маршрутизации.     
![ip r ws11](img/5-3-ip-r-ws11.png)     
![ip r ws21](img/5-3-ip-r-ws21.png)     
![ip r ws22](img/5-3-ip-r-ws22.png)      
- Пропингуй с ws11 роутер r2 и покажи на r2, что пинг доходит. Для этого используй команду: tcpdump -tn -i eth0      
  - На роутере r2 запускаем tcpdump: sudo tcpdump -tn -i enp0s9 icmp   
  фильтр icmp чтобы видеть только ping пакеты      
  ![tcpdump r2](img/5-3-tcpdump-r2.png)
  - На ws11 запускаем ping до r2: ping -c 4 10.100.0.12
  ![ping до r2](img/5-3-ping-ws11-r2.png)     
4. Добавление статических маршрутов   
- Добавь в роутеры r1 и r2 статические маршруты в файле конфигураций   
![netplan r1](img/5-4-netplan-r1.png)     
![netplan r2](img/5-4-netplan-r2.png)   
sudo netplan apply       
- Вызови ip r и покажи таблицы с маршрутами на обоих роутерах  5
![ip r r1](img/5-4-ip-r-r1.png)     
![ip r r2](img/5-4-ip-r-r2.png)     
- Запусти команды на ws11: ip r list 10.10.0.0/[маска сети] и ip r list 0.0.0.0/0    
![ip r list 10.10.0.0/[маска сети] и ip r list 0.0.0.0/0 на ws11](img/5-4-ws11.png)      
В Linux маршрутизация работает по принципу наиболее специфичного совпадения (longest prefix match). Это означает:
- Маршрут 0.0.0.0/0 — это маршрут по умолчанию (шлюз по умолчанию), который соответствует любому IP-адресу   
- Маршрут 10.10.0.0/18 — более специфичный маршрут, который покрывает диапазон адресов 10.10.0.0 - 10.10.63.255   
При запросе маршрута для 10.10.0.0/18:
- Система ищет наиболее точное совпадение в таблице маршрутизации    
- Маршрут 10.10.0.0/18 (маска /18 = 255.255.192.0) является более специфичным, чем 0.0.0.0/0 (маска /0 = 0.0.0.0)   
- Поэтому выбирается явно прописанный маршрут для сети 10.10.0.0/18, а не маршрут по умолчанию   
5. Построение списка маршрутизаторов    
- Запустите tcpdump -tnv -i eth0s8 команду дампа на r1    
- установить traceroute: sudo apt install traceroute   
- на ws11 запустить traceroute до ws21: traceroute 10.20.0.10    
![tcpdump на r1 и traceroute от ws11 до ws21](img/5-5.png)   
Принцип работы:
- Traceroute отправляет UDP-пакеты с увеличивающимся TTL (Time To Live)  
- TTL=1 для первого хопа, TTL=2 для второго и т.д.   
- Когда TTL достигает 0, маршрутизатор отбрасывает пакет и отправляет обратно ICMP "Time Exceeded"   
- Пакет 1: TTL=1 → достигает r1 → TTL=0 → ICMP "Time Exceeded" от r1
- Пакет 2: TTL=2 → проходит r1 (TTL=1) → достигает ws21 → цель отвечает
- Traceroute измеряет время между отправкой и получением ответа
6. Использование протокола ICMP в маршрутизации      
- Запустить на r1 захват сетевого трафика, проходящего через eth0 с: tcpdump -n -i eth0s8 icmp   
- Выполните пинг несуществующего IP-адреса (например, 10.30.0.111 ) с помощью ws11: ping -c 1 10.30.0.111    
![Использование протокола ICMP в маршрутизации](img/5-6.png)  

## Часть 6. Динамическая настройка IP с использованием DHCP 
1. Для r2 настройте службу DHCP в файле /etc/dhcp/dhcpd.conf : 
- Укажите адрес маршрутизатора по умолчанию, DNS-сервер и адрес внутренней сети   
![настройка службуы DHCP на r2](img/6-r2.png)    
2. Записать nameserver 8.8.8.8 в файл resolv.conf    
![resolv.conf r2](img/6-resolv-r2.png)     
- Перезапустите службу DHCP с помощью systemctl restart isc-dhcp-server.    
![Перезапустите службу DHCP на r2](img/6-restart-dhcp-r2.png)   
- Перезагрузите машину ws21 с помощью reboot, чтобы показать ip a, что она получила адрес.  
![ip a ws21](img/6-ip-r-ws21.png)    
- ping с ws21 на ws22   
![ping с ws21 на ws22](img/6-ping-ws21-ws22.png)    
- Укажите MAC-адрес на ws11, добавив в etc/netplan/00-installer-config.yaml: macaddress: 10:10:10:10:10:BA,dhcp4: true
![MAC-адрес на ws11](img/6-MACaddress-ws11.png)    
- Настройте r1 так же, как r2, но сделайте назначение адресов строго привязанным к MAC-адресу (ws11). Проведите те же тесты.
![настройка службуы DHCP на r1](img/6-r1.png)
![resolv.conf r1](img/6-resolv-r1.png)
![Перезапустите службу DHCP на r1](img/6-restart-dhcp-r1.png)
![ip a ws11 после sudo reboot](img/6-ip-a-ws11.png)
- Запросить обновление IP-адреса у ws21: sudo dhclient enp0s8
![ip a ws21 до обновления](img/6-ip-a-ws21-before.png)
![ip a ws21 после обновления](img/6-ip-a-ws21-after.png)

## Часть 7. НАТ
1. В файле /etc/apache2/ports.conf измените строку Listen 80 на Listen 0.0.0.0:80 on ws22 и r1, т.е. сделайте сервер Apache2 публичным    
- устанавливаем apache: sudo apt install apache2 -y   
- редактируем apache: sudo nano /etc/apache2/ports.conf 
- Перезапускаем Apache: sudo systemctl restart apache2  
![редактируем apache r1](img/7-1-r1.png)    
![редактируем apache ws22](img/7-1-ws22.png)    
2. Запустите веб-сервер Apache с помощью service apache2 startкоманды на ws22 и r1   
![Запуск Apache r1](img/7-2-r1.png)   
![Запуск Apache ws22](img/7-2-ws22.png)    
3. Добавьте следующие правила в брандмауэр, созданный аналогично брандмауэру из части 4, на r2: 
- удалить правила в таблице фильтров —iptables -F. 
- удалить правила в таблице «NAT» —iptables -F -t nat.  
- отбросить все маршрутизируемые пакеты —iptables --policy FORWARD DROP. 
![firewall.sh r2](img/7-3-1.png)   
- Запустите файл   
![sudo chmod +x /etc/firewall.sh и sudo /etc/firewall.sh](img/7-3-2.png)
- Проверьте соединение между ws22 и r1 с помощью ping команды (При запуске файла с этими правилами ws22 не должен пинговаться с r1) 
![ping между ws22 и r1 не проходит](img/7-3-3.png)   
- разрешить маршрутизацию всех пакетов протокола ICMP   
![разрешить маршрутизацию всех пакетов протокола ICMP r2](img/7-3-4.png)     
- Запустите файл    
![sudo /etc/firewall.sh](img/7-3-5.png)     
- Проверьте соединение между ws22 и r1 с помощью ping команды (При запуске файла с этими правилами ws22 должен пинговаться с r1)
![ping между ws22 и r1](img/7-3-6.png)     
- включить SNAT , который маскирует все локальные IP-адреса из локальной сети за r2 (как определено в части 5 — сеть 10.20.0.0).  
- включите DNAT на порту 8080 машины r2 и добавьте внешний сетевой доступ к веб-серверу Apache, работающему на ws22  
![включили SNAT и DNAT](img/7-3-7.png)    
- Проверьте TCP-соединение для SNAT , подключившись из ws22 к серверу Apache на r1 с помощью telnet [address] [port]команды.  
![подключение snat ws22 к r1](img/7-3-8.png)   
- Проверьте TCP-соединение для DNAT , подключившись с r1 к серверу Apache на ws22 с помощью telnetкоманды (адрес r2 и порт 8080). 
![подключение dnat r1 к ws22](img/7-3-9.png)     